{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-chart-bar me-2"></i>Informes de Resultados</h2>
        <p class="text-muted">Analiza tus resultados econ√≥micos y estad√≠sticas de juego.</p>
        
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Filtros</h6>
            </div>
            <div class="card-body">
                <form id="filtrosForm">
                    <div class="mb-3">
                        <label for="fecha_inicio" class="form-label">Fecha Inicio</label>
                        <input type="date" class="form-control" id="fecha_inicio" name="fecha_inicio">
                    </div>
                    
                    <div class="mb-3">
                        <label for="fecha_fin" class="form-label">Fecha Fin</label>
                        <input type="date" class="form-control" id="fecha_fin" name="fecha_fin">
                    </div>
                    
                    <!-- Filtros r√°pidos de fechas -->
                    <div class="mb-3">
                        <label for="filtro_rapido" class="form-label">Filtros R√°pidos</label>
                        <select class="form-select" id="filtro_rapido" onchange="aplicarFiltroRapido(this.value)">
                            <option value="">Seleccionar per√≠odo...</option>
                            <option value="hoy">üìÖ Hoy</option>
                            <option value="ayer">üìÖ Ayer</option>
                            <option value="esta_semana">üìÖ Esta Semana</option>
                            <option value="este_mes">üìÖ Este Mes</option>
                            <option value="mes_pasado">üìÖ Mes Pasado</option>
                            <option value="este_a√±o">üìÖ Este A√±o</option>
                            <option value="a√±o_pasado">üìÖ A√±o Pasado</option>
                            <option value="2024">üìÖ 2024</option>
                            <option value="2023">üìÖ 2023</option>
                            <option value="2022">üìÖ 2022</option>
                            <option value="2021">üìÖ 2021</option>
                            <option value="2020">üìÖ 2020</option>
                        </select>
                    </div>
                    
                    <!-- Campo de b√∫squeda -->
                    <div class="mb-3">
                        <label for="busqueda" class="form-label">üîç Buscar Registros</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="busqueda" name="busqueda" placeholder="Buscar en descripci√≥n, sala, tipo de movimiento...">
                            <button class="btn btn-outline-secondary" type="button" onclick="limpiarBusqueda()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <small class="form-text text-muted">Busca en descripci√≥n, sala, tipo de movimiento y categor√≠a</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="tipo_movimiento" class="form-label">Tipo de Movimiento</label>
                        <select class="form-select" id="tipo_movimiento" name="tipo_movimiento">
                            <option value="">Todos</option>
                            <option value="Buy-in">Buy-in</option>
                            <option value="Cashout">Cashout</option>
                            <option value="Fee">Fee</option>
                            <option value="Prize">Prize</option>
                        </select>
                    </div>
                    
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">Categor√≠as</label>
                            <div>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="seleccionarTodos('categorias[]')">Todos</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deseleccionarTodos('categorias[]')">Ninguno</button>
                            </div>
                        </div>
                        <div id="categorias-filtro" class="border rounded p-2" style="max-height: 150px; overflow-y: auto;">
                            <!-- Se llenar√° din√°micamente -->
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">Tipos de Juego</label>
                            <div>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="seleccionarTodos('tipos_juego[]')">Todos</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deseleccionarTodos('tipos_juego[]')">Ninguno</button>
                            </div>
                        </div>
                        <div id="tipos-juego-filtro" class="border rounded p-2" style="max-height: 150px; overflow-y: auto;">
                            <!-- Se llenar√° din√°micamente -->
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">Nivel de Buy-in</label>
                            <div>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="seleccionarTodos('niveles_buyin[]')">Todos</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deseleccionarTodos('niveles_buyin[]')">Ninguno</button>
                            </div>
                        </div>
                        <div id="niveles-buyin-filtro" class="border rounded p-2" style="max-height: 150px; overflow-y: auto;">
                            <!-- Se llenar√° din√°micamente -->
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">Sala</label>
                            <div>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="seleccionarTodos('salas[]')">Todos</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deseleccionarTodos('salas[]')">Ninguno</button>
                            </div>
                        </div>
                        <div id="salas-filtro" class="border rounded p-2" style="max-height: 150px; overflow-y: auto;">
                            <!-- Se llenar√° din√°micamente -->
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-filter me-2"></i>Aplicar Filtros
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Estad√≠sticas Generales</h6>
            </div>
            <div class="card-body">
                <div class="row" id="estadisticas">
                    <!-- Primera fila -->
                    <div class="col-md-3 text-center mb-3">
                        <div class="border rounded p-3 h-100">
                            <h4 class="text-success mb-1" id="cantidad_torneos" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">0</h4>
                            <small class="text-muted">Torneos Jugados</small>
                        </div>
                    </div>
                    <div class="col-md-3 text-center mb-3">
                        <div class="border rounded p-3 h-100">
                            <h4 class="text-danger mb-1" id="total_invertido" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">$0.00</h4>
                            <small class="text-muted">Total Invertido</small>
                        </div>
                    </div>
                    <div class="col-md-3 text-center mb-3">
                        <div class="border rounded p-3 h-100">
                            <h4 class="text-success mb-1" id="total_ganancias" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">$0.00</h4>
                            <small class="text-muted">Total Ganancias</small>
                        </div>
                    </div>
                    <div class="col-md-3 text-center mb-3">
                        <div class="border rounded p-3 h-100">
                            <h4 class="text-info mb-1" id="total_registros" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">0</h4>
                            <small class="text-muted">Total Registros</small>
                            <div class="mt-2">
                                <h5 class="text-secondary mb-0" id="suma_importes" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">$0.00</h5>
                                <small class="text-muted">Suma Importes</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Segunda fila -->
                    <div class="col-md-6 text-center mb-3">
                        <div class="border rounded p-3 h-100">
                            <h4 class="text-warning mb-1" id="roi" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">0%</h4>
                            <small class="text-muted">ROI</small>
                        </div>
                    </div>
                    <div class="col-md-6 text-center mb-3">
                        <div class="border rounded p-3 h-100">
                            <h4 class="text-primary mb-1" id="resultado_economico" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">$0.00</h4>
                            <small class="text-muted">Resultado Econ√≥mico</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Gr√°fico de resultados diarios -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">Resultados Diarios (√öltimos 10 D√≠as)</h6>
            </div>
            <div class="card-body">
                <canvas id="graficoResultadosDiarios" style="height: 200px;"></canvas>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">Resultados Detallados</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="tablaResultados" style="font-size: 0.875rem;">
                        <thead>
                            <tr>
                                <th class="sortable" data-column="fecha" style="cursor: pointer;">
                                    Fecha <i class="fas fa-sort ms-1"></i>
                                </th>
                                <th class="sortable" data-column="hora" style="cursor: pointer;">
                                    Hora <i class="fas fa-sort ms-1"></i>
                                </th>
                                <th class="sortable" data-column="tipo_movimiento" style="cursor: pointer;">
                                    Tipo <i class="fas fa-sort ms-1"></i>
                                </th>
                                <th class="sortable" data-column="descripcion" style="cursor: pointer;">
                                    Descripci√≥n <i class="fas fa-sort ms-1"></i>
                                </th>
                                <th class="sortable" data-column="importe" style="cursor: pointer;">
                                    Importe <i class="fas fa-sort ms-1"></i>
                                </th>
                                <th class="sortable" data-column="categoria" style="cursor: pointer;">
                                    Categor√≠a <i class="fas fa-sort ms-1"></i>
                                </th>
                                <th class="sortable" data-column="tipo_juego" style="cursor: pointer;">
                                    Juego <i class="fas fa-sort ms-1"></i>
                                </th>
                                <th class="sortable" data-column="nivel_buyin" style="cursor: pointer;">
                                    Nivel Buy-in <i class="fas fa-sort ms-1"></i>
                                </th>
                                <th class="sortable" data-column="sala" style="cursor: pointer;">
                                    Sala <i class="fas fa-sort ms-1"></i>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Los datos se cargar√°n din√°micamente -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Controles de paginaci√≥n -->
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div>
                        <span id="infoPaginacion" class="text-muted">Mostrando registros...</span>
                    </div>
                    <div>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary btn-sm" id="btnAnterior" onclick="cambiarPagina(-1)" disabled>
                                <i class="fas fa-chevron-left"></i> Anterior
                            </button>
                            <span class="btn btn-outline-secondary btn-sm disabled" id="infoPagina">
                                P√°gina 1 de 1
                            </span>
                            <button type="button" class="btn btn-outline-primary btn-sm" id="btnSiguiente" onclick="cambiarPagina(1)" disabled>
                                Siguiente <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Selector de registros por p√°gina -->
                <div class="mt-2">
                    <small class="text-muted">Registros por p√°gina: </small>
                    <select class="form-select form-select-sm d-inline-block w-auto" id="perPageSelect" onchange="cambiarRegistrosPorPagina()">
                        <option value="25">25</option>
                        <option value="50" selected>50</option>
                        <option value="100">100</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let opcionesDisponibles = {};
let paginaActual = 1;
let registrosPorPagina = 50;
let totalPaginas = 1;
let busquedaActual = '';

document.getElementById('filtrosForm').addEventListener('submit', function(e) {
    e.preventDefault();
    cargarInformes();
});

function cargarOpciones() {
    // Cargar todas las opciones con el endpoint principal
    fetch('/api/informes/opciones')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            opcionesDisponibles = data.opciones;
            crearFiltrosMultiples();
        } else {
            console.error('Error en respuesta:', data.error);
        }
    })
    .catch(error => {
        console.error('Error al cargar opciones:', error);
    });
}


function crearFiltrosMultiples() {
    // Crear filtros de categor√≠as
    const categoriasDiv = document.getElementById('categorias-filtro');
    categoriasDiv.innerHTML = '';
    
    if (opcionesDisponibles.categorias && Array.isArray(opcionesDisponibles.categorias)) {
        opcionesDisponibles.categorias.forEach(categoria => {
        const div = document.createElement('div');
        div.className = 'form-check';
        div.innerHTML = `
            <input class="form-check-input" type="checkbox" value="${categoria}" 
                   id="cat_${categoria}" name="categorias[]">
            <label class="form-check-label" for="cat_${categoria}">
                ${categoria}
            </label>
        `;
        categoriasDiv.appendChild(div);
        });
    }
    
    // Crear filtros de tipos de juego
    const tiposJuegoDiv = document.getElementById('tipos-juego-filtro');
    tiposJuegoDiv.innerHTML = '';
    
    if (opcionesDisponibles.tipos_juego && Array.isArray(opcionesDisponibles.tipos_juego)) {
        opcionesDisponibles.tipos_juego.forEach(tipo => {
        const div = document.createElement('div');
        div.className = 'form-check';
        div.innerHTML = `
            <input class="form-check-input" type="checkbox" value="${tipo}" 
                   id="tipo_${tipo}" name="tipos_juego[]">
            <label class="form-check-label" for="tipo_${tipo}">
                ${tipo}
            </label>
        `;
        tiposJuegoDiv.appendChild(div);
        });
    }
    
    // Crear filtros de niveles de buy-in
    const nivelesBuyinDiv = document.getElementById('niveles-buyin-filtro');
    nivelesBuyinDiv.innerHTML = '';
    
    if (opcionesDisponibles.niveles_buyin && Array.isArray(opcionesDisponibles.niveles_buyin)) {
        opcionesDisponibles.niveles_buyin.forEach(nivel => {
        const div = document.createElement('div');
        div.className = 'form-check';
        div.innerHTML = `
            <input class="form-check-input" type="checkbox" value="${nivel}" 
                   id="nivel_${nivel}" name="niveles_buyin[]">
            <label class="form-check-label" for="nivel_${nivel}">
                ${nivel}
            </label>
        `;
        nivelesBuyinDiv.appendChild(div);
        });
    }
    
    // Crear filtros de salas
    const salasDiv = document.getElementById('salas-filtro');
    salasDiv.innerHTML = '';
    
    if (opcionesDisponibles.salas && Array.isArray(opcionesDisponibles.salas)) {
        opcionesDisponibles.salas.forEach(sala => {
        const div = document.createElement('div');
        div.className = 'form-check';
        div.innerHTML = `
            <input class="form-check-input" type="checkbox" value="${sala}" 
                   id="sala_${sala}" name="salas[]">
            <label class="form-check-label" for="sala_${sala}">
                ${sala}
            </label>
        `;
        salasDiv.appendChild(div);
        });
    }
    
    // Actualizar opciones de tipo de movimiento
    const tipoMovimientoSelect = document.getElementById('tipo_movimiento');
    tipoMovimientoSelect.innerHTML = '<option value="">Todos</option>';
    if (opcionesDisponibles.tipos_movimiento && Array.isArray(opcionesDisponibles.tipos_movimiento)) {
        opcionesDisponibles.tipos_movimiento.forEach(tipo => {
        const option = document.createElement('option');
        option.value = tipo;
        option.textContent = tipo;
        tipoMovimientoSelect.appendChild(option);
        });
    }
}

function cargarInformes() {
    const formData = new FormData(document.getElementById('filtrosForm'));
    const params = new URLSearchParams();
    
    // Agregar filtros b√°sicos
    for (let [key, value] of formData.entries()) {
        if (value && key !== 'categorias[]' && key !== 'tipos_juego[]' && key !== 'niveles_buyin[]' && key !== 'salas[]') {
            params.append(key, value);
        }
    }
    
    // Agregar filtros m√∫ltiples
    const categoriasSeleccionadas = Array.from(document.querySelectorAll('input[name="categorias[]"]:checked'))
        .map(cb => cb.value);
    categoriasSeleccionadas.forEach(cat => params.append('categorias[]', cat));
    
    const tiposJuegoSeleccionados = Array.from(document.querySelectorAll('input[name="tipos_juego[]"]:checked'))
        .map(cb => cb.value);
    tiposJuegoSeleccionados.forEach(tipo => params.append('tipos_juego[]', tipo));
    
    const nivelesBuyinSeleccionados = Array.from(document.querySelectorAll('input[name="niveles_buyin[]"]:checked'))
        .map(cb => cb.value);
    nivelesBuyinSeleccionados.forEach(nivel => params.append('niveles_buyin[]', nivel));
    
    const salasSeleccionadas = Array.from(document.querySelectorAll('input[name="salas[]"]:checked'))
        .map(cb => cb.value);
    salasSeleccionadas.forEach(sala => params.append('salas[]', sala));
    
    fetch(`/api/informes/resultados?${params}`)
    .then(response => response.json())
    .then(data => {
        console.log('üìä DEBUG - Datos recibidos del backend:', data);
        if (data.success && data.resultados) {
            console.log('üìä DEBUG - Estad√≠sticas en data.resultados:', {
                torneos_jugados: data.resultados.torneos_jugados,
                total_invertido: data.resultados.total_invertido,
                total_ganancias: data.resultados.total_ganancias,
                roi: data.resultados.roi,
                resultado_economico: data.resultados.resultado_economico
            });
            
            // Actualizar estad√≠sticas correctamente
            document.getElementById('cantidad_torneos').textContent = 
                data.resultados.torneos_jugados || 0;
            document.getElementById('total_registros').textContent = 
                data.resultados.total_registros || 0;
            
            // Total invertido (importes negativos como positivos)
            document.getElementById('total_invertido').textContent = 
                '$' + (data.resultados.total_invertido || 0).toFixed(2);
            
            // Total ganancias (importes positivos)
            document.getElementById('total_ganancias').textContent = 
                '$' + (data.resultados.total_ganancias || 0).toFixed(2);
            
            // ROI calculado en el backend
            document.getElementById('roi').textContent = 
                (data.resultados.roi || 0).toFixed(1) + '%';
            
            // Suma de importes (balance total)
            const sumaImportes = data.resultados.total_importe || 0;
            const colorSuma = sumaImportes >= 0 ? 'text-success' : 'text-danger';
            document.getElementById('suma_importes').textContent = 
                '$' + sumaImportes.toFixed(2);
            document.getElementById('suma_importes').className = 
                colorSuma + ' mb-0';
            
            // Resultado econ√≥mico (ganancias - inversi√≥n)
            const resultadoEconomico = data.resultados.resultado_economico || 0;
            const colorResultado = resultadoEconomico >= 0 ? 'text-success' : 'text-danger';
            document.getElementById('resultado_economico').textContent = 
                '$' + resultadoEconomico.toFixed(2);
            document.getElementById('resultado_economico').className = 
                colorResultado + ' mb-1';
            
            // Obtener datos para el gr√°fico de √∫ltimos 10 d√≠as
            obtenerDatosGrafico().then(resultadosDiarios => {
                // Generar gr√°fico de resultados diarios cuando el DOM est√© listo
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => {
                        setTimeout(() => {
                            generarGraficoResultadosDiarios(resultadosDiarios);
                        }, 1000);
                    });
                } else {
                    setTimeout(() => {
                        generarGraficoResultadosDiarios(resultadosDiarios);
                    }, 1000);
                }
            });
            
            // Almacenar datos globalmente para ordenamiento
            window.datosResultados = data.resultados.registros || [];
            
            // Actualizar tabla usando la funci√≥n de ordenamiento
            actualizarTablaResultados();
        } else {
            console.error('Error en respuesta:', data.error || 'Respuesta inv√°lida');
            
            // Limpiar datos en caso de error
            document.getElementById('cantidad_torneos').textContent = '0';
            document.getElementById('total_registros').textContent = '0';
            document.getElementById('suma_importes').textContent = '$0.00';
            document.getElementById('total_invertido').textContent = '$0.00';
            document.getElementById('total_ganancias').textContent = '$0.00';
            document.getElementById('roi').textContent = '0.0%';
            document.getElementById('resultado_economico').textContent = '$0.00';
            
            // Limpiar gr√°fico y tabla
            window.datosResultados = [];
            actualizarTablaResultados();
            
            // Mostrar mensaje de error al usuario
            let mensajeError = data.error || 'Error desconocido';
            if (mensajeError.includes('Resource temporarily unavailable') || mensajeError.includes('ReadError')) {
                mensajeError = 'Error de conexi√≥n con la base de datos. Por favor, intenta nuevamente en unos momentos.';
            }
            alert('Error al cargar los informes: ' + mensajeError);
        }
    })
    .catch(error => {
        console.error('Error al cargar informes:', error);
        alert('Error de conexi√≥n. Por favor, verifica tu conexi√≥n a internet e intenta nuevamente.');
    });
}

// Funciones para seleccionar/deseleccionar todos los filtros
// Funci√≥n para aplicar filtros r√°pidos de fechas
function aplicarFiltroRapido(tipo) {
    // Si no se seleccion√≥ nada, no hacer nada
    if (!tipo) return;
    
    const hoy = new Date();
    const fechaInicio = document.getElementById('fecha_inicio');
    const fechaFin = document.getElementById('fecha_fin');
    const filtroRapido = document.getElementById('filtro_rapido');
    
    let inicio, fin;
    
    switch(tipo) {
        case 'hoy':
            inicio = fin = hoy;
            break;
            
        case 'ayer':
            const ayer = new Date(hoy);
            ayer.setDate(hoy.getDate() - 1);
            inicio = fin = ayer;
            break;
            
        case 'esta_semana':
            const inicioSemana = new Date(hoy);
            inicioSemana.setDate(hoy.getDate() - hoy.getDay()); // Domingo
            const finSemana = new Date(hoy);
            finSemana.setDate(hoy.getDate() + (6 - hoy.getDay())); // S√°bado
            inicio = inicioSemana;
            fin = finSemana;
            break;
            
        case 'este_mes':
            inicio = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
            fin = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0);
            break;
            
        case 'mes_pasado':
            const mesPasado = new Date(hoy.getFullYear(), hoy.getMonth() - 1, 1);
            inicio = new Date(mesPasado.getFullYear(), mesPasado.getMonth(), 1);
            fin = new Date(mesPasado.getFullYear(), mesPasado.getMonth() + 1, 0);
            break;
            
        case 'este_a√±o':
            inicio = new Date(hoy.getFullYear(), 0, 1);
            fin = new Date(hoy.getFullYear(), 11, 31);
            break;
            
        case 'a√±o_pasado':
            const a√±oPasado = hoy.getFullYear() - 1;
            inicio = new Date(a√±oPasado, 0, 1);
            fin = new Date(a√±oPasado, 11, 31);
            break;
            
        case '2024':
            inicio = new Date(2024, 0, 1);
            fin = new Date(2024, 11, 31);
            break;
            
        case '2023':
            inicio = new Date(2023, 0, 1);
            fin = new Date(2023, 11, 31);
            break;
            
        case '2022':
            inicio = new Date(2022, 0, 1);
            fin = new Date(2022, 11, 31);
            break;
            
        case '2021':
            inicio = new Date(2021, 0, 1);
            fin = new Date(2021, 11, 31);
            break;
            
        case '2020':
            inicio = new Date(2020, 0, 1);
            fin = new Date(2020, 11, 31);
            break;
            
        default:
            return;
    }
    
    // Formatear fechas para el input date (YYYY-MM-DD)
    const formatearFecha = (fecha) => {
        return fecha.getFullYear() + '-' + 
               String(fecha.getMonth() + 1).padStart(2, '0') + '-' + 
               String(fecha.getDate()).padStart(2, '0');
    };
    
    // Aplicar las fechas
    fechaInicio.value = formatearFecha(inicio);
    fechaFin.value = formatearFecha(fin);
    
    // Resetear el men√∫ desplegable
    filtroRapido.value = '';
    
    // Recargar informes autom√°ticamente
    cargarInformes();
}

function seleccionarTodos(name) {
    const checkboxes = document.querySelectorAll(`input[name="${name}"]`);
    checkboxes.forEach(cb => cb.checked = true);
}

function deseleccionarTodos(name) {
    const checkboxes = document.querySelectorAll(`input[name="${name}"]`);
    checkboxes.forEach(cb => cb.checked = false);
}

// Funci√≥n para obtener datos del gr√°fico de √∫ltimos 10 d√≠as
function obtenerDatosGrafico() {
    return fetch('/api/informes/ultimos-10-dias')
        .then(response => response.json())
        .then(graficoData => {
            console.log('üìä Datos del gr√°fico recibidos:', graficoData);
            if (graficoData.resultados_diarios) {
                return graficoData.resultados_diarios;
            } else {
                console.warn('No se encontraron datos de resultados_diarios en la respuesta del gr√°fico');
                return [];
            }
        })
        .catch(error => {
            console.error('Error al obtener datos del gr√°fico:', error);
            return [];
        });
}

// Funci√≥n para generar el gr√°fico de resultados diarios
function generarGraficoResultadosDiarios(resultadosDiarios) {
    console.log('Intentando generar gr√°fico con datos procesados...', resultadosDiarios);
    
    const ctx = document.getElementById('graficoResultadosDiarios');
    
    // Verificar que el elemento existe
    if (!ctx) {
        console.error('No se encontr√≥ el elemento graficoResultadosDiarios');
        return;
    }
    
    // Verificar que el elemento est√° visible y tiene dimensiones
    if (ctx.offsetWidth === 0 || ctx.offsetHeight === 0) {
        console.error('El elemento graficoResultadosDiarios no tiene dimensiones visibles');
        console.log('Reintentando en 500ms...');
        setTimeout(() => {
            generarGraficoResultadosDiarios(resultadosDiarios);
        }, 500);
        return;
    }
    
    console.log('Elemento encontrado:', ctx);
    console.log('Dimensiones:', ctx.offsetWidth, 'x', ctx.offsetHeight);
    
    // Destruir gr√°fico existente si existe
    if (window.graficoResultadosDiarios && typeof window.graficoResultadosDiarios.destroy === 'function') {
        console.log('Destruyendo gr√°fico existente...');
        window.graficoResultadosDiarios.destroy();
    }
    
    // Verificar que tenemos datos v√°lidos ya procesados desde el backend
    if (!resultadosDiarios || !Array.isArray(resultadosDiarios) || resultadosDiarios.length === 0) {
        console.warn('No hay datos v√°lidos para generar el gr√°fico - usando datos vac√≠os para los √∫ltimos 10 d√≠as');
        
        // Crear datos vac√≠os para los √∫ltimos 10 d√≠as si no hay datos
        const hoy = new Date();
        resultadosDiarios = [];
        for (let i = 9; i >= 0; i--) {
            const fecha = new Date(hoy);
            fecha.setDate(fecha.getDate() - i);
            resultadosDiarios.push({
                fecha: fecha.toISOString().split('T')[0],
                resultado: 0,
                movimientos: 0
            });
        }
    }
    
    // Los datos ya vienen procesados del backend con los √∫ltimos 10 d√≠as
    // Preparar datos para el gr√°fico
    const fechas = resultadosDiarios.map(d => {
        const fecha = new Date(d.fecha);
        return fecha.toLocaleDateString('es-ES', { month: 'short', day: 'numeric' });
    });
    
    const resultados = resultadosDiarios.map(d => d.resultado || 0);
    const colores = resultados.map(r => r >= 0 ? '#28a745' : '#dc3545');
    
    // Crear gr√°fico con manejo de errores
    console.log('Preparando datos para el gr√°fico...');
    console.log('Fechas:', fechas);
    console.log('Resultados:', resultados);
    console.log('Colores:', colores);
    
    try {
        console.log('Creando gr√°fico con Chart.js...');
        window.graficoResultadosDiarios = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: fechas,
                datasets: [{
                    label: 'Resultado Diario ($)',
                    data: resultados,
                    backgroundColor: colores,
                    borderColor: colores,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const valor = context.parsed.y;
                                const movimientos = resultadosDiarios[context.dataIndex].movimientos || 0;
                                return `$${valor.toFixed(2)} (${movimientos} movimientos)`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toFixed(0);
                            }
                        }
                    },
                    x: {
                        ticks: {
                            maxRotation: 45
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error al crear el gr√°fico:', error);
        // Mostrar mensaje de error en el contenedor
        ctx.innerHTML = '<div class="alert alert-warning">Error al cargar el gr√°fico de resultados diarios</div>';
    }
}

// Variables globales para ordenamiento
let ordenActual = { columna: null, direccion: 'asc' };

// Funci√≥n para ordenar los datos
function ordenarDatos(columna, direccion) {
    if (!window.datosResultados || !Array.isArray(window.datosResultados)) {
        console.error('‚ùå No hay datos para ordenar');
        return;
    }
    
    window.datosResultados.sort((a, b) => {
        let valorA = a[columna];
        let valorB = b[columna];
        
        // Manejar valores nulos o undefined
        if (valorA === null || valorA === undefined) valorA = '';
        if (valorB === null || valorB === undefined) valorB = '';
        
        // Convertir a string para comparaci√≥n
        valorA = String(valorA).toLowerCase();
        valorB = String(valorB).toLowerCase();
        
        // Ordenamiento especial para fechas
        if (columna === 'fecha') {
            valorA = new Date(a.fecha);
            valorB = new Date(b.fecha);
        }
        
        // Ordenamiento especial para importes
        if (columna === 'importe') {
            valorA = parseFloat(a.importe) || 0;
            valorB = parseFloat(b.importe) || 0;
        }
        
        // Ordenamiento especial para hora
        if (columna === 'hora') {
            valorA = a.hora ? new Date('1970-01-01T' + a.hora) : new Date('1970-01-01T00:00:00');
            valorB = b.hora ? new Date('1970-01-01T' + b.hora) : new Date('1970-01-01T00:00:00');
        }
        
        if (direccion === 'asc') {
            return valorA < valorB ? -1 : valorA > valorB ? 1 : 0;
        } else {
            return valorA > valorB ? -1 : valorA < valorB ? 1 : 0;
        }
    });
    
    // Actualizar la tabla con los datos ordenados
    actualizarTablaResultados();
}

// Funci√≥n para actualizar la tabla con los datos ordenados
function actualizarTablaResultados() {
    console.log('üîÑ Actualizando tabla de resultados...');
    
    const tbody = document.querySelector('#tablaResultados tbody');
    if (!tbody) {
        console.error('‚ùå No se encontr√≥ el tbody de la tabla');
        return;
    }
    
    tbody.innerHTML = '';
    
    if (!window.datosResultados || !Array.isArray(window.datosResultados)) {
        console.error('‚ùå datosResultados no es un array v√°lido:', window.datosResultados);
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">No hay datos para mostrar</td></tr>';
        return;
    }
    
    console.log('üìä Procesando', window.datosResultados.length, 'registros para la tabla');
    
    if (window.datosResultados.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">No se encontraron registros</td></tr>';
        return;
    }
    
    window.datosResultados.forEach((resultado, index) => {
        try {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${resultado.fecha || '-'}</td>
                <td>${resultado.hora || '-'}</td>
                <td>${resultado.tipo_movimiento || '-'}</td>
                <td title="${resultado.descripcion || ''}">${(resultado.descripcion || '').substring(0, 50)}${(resultado.descripcion || '').length > 50 ? '...' : ''}</td>
                <td class="${resultado.importe >= 0 ? 'text-success' : 'text-danger'}">
                    $${parseFloat(resultado.importe || 0).toFixed(2)}
                </td>
                <td>${resultado.categoria || '-'}</td>
                <td>${resultado.tipo_juego || '-'}</td>
                <td>${resultado.nivel_buyin || '-'}</td>
                <td>${resultado.sala || '-'}</td>
            `;
            tbody.appendChild(row);
        } catch (e) {
            console.error('‚ùå Error procesando registro', index, ':', e, resultado);
        }
    });
    
    console.log('‚úÖ Tabla actualizada con', window.datosResultados.length, 'registros');
}

// Funci√≥n para manejar el clic en los headers
function manejarOrdenamiento(columna) {
    console.log('üîÑ Ordenando por columna:', columna);
    
    // Determinar la direcci√≥n del ordenamiento
    let direccion = 'asc';
    if (ordenActual.columna === columna && ordenActual.direccion === 'asc') {
        direccion = 'desc';
    }
    
    console.log('üìä Direcci√≥n de ordenamiento:', direccion);
    
    // Actualizar el estado del ordenamiento
    ordenActual.columna = columna;
    ordenActual.direccion = direccion;
    
    // Actualizar los iconos de ordenamiento
    document.querySelectorAll('.sortable i').forEach(icon => {
        icon.className = 'fas fa-sort ms-1';
    });
    
    // Actualizar el icono de la columna actual
    const headerActual = document.querySelector(`[data-column="${columna}"] i`);
    if (direccion === 'asc') {
        headerActual.className = 'fas fa-sort-up ms-1 text-primary';
    } else {
        headerActual.className = 'fas fa-sort-down ms-1 text-primary';
    }
    
    // Ordenar los datos
    ordenarDatos(columna, direccion);
}

// Agregar event listeners a los headers
document.addEventListener('DOMContentLoaded', function() {
    // Esperar a que se carguen los datos antes de agregar los event listeners
    setTimeout(() => {
        document.querySelectorAll('.sortable').forEach(header => {
            header.addEventListener('click', function() {
                const columna = this.getAttribute('data-column');
                manejarOrdenamiento(columna);
            });
        });
    }, 1000);
});

// Funciones de paginaci√≥n y b√∫squeda
function cambiarPagina(direccion) {
    const nuevaPagina = paginaActual + direccion;
    if (nuevaPagina >= 1 && nuevaPagina <= totalPaginas) {
        paginaActual = nuevaPagina;
        cargarInformes();
    }
}

function cambiarRegistrosPorPagina() {
    registrosPorPagina = parseInt(document.getElementById('perPageSelect').value);
    paginaActual = 1; // Resetear a la primera p√°gina
    cargarInformes();
}

function limpiarBusqueda() {
    document.getElementById('busqueda').value = '';
    busquedaActual = '';
    paginaActual = 1;
    cargarInformes();
}

function actualizarControlesPaginacion(data) {
    // Nota: La paginaci√≥n se maneja en el frontend por simplicidad
    // El servidor devuelve todos los datos filtrados, el frontend los pagina

    // Actualizar informaci√≥n de registros si est√° disponible
    if (data.estadisticas && data.estadisticas.total_registros !== undefined) {
        const totalRegistros = data.estadisticas.total_registros;
        const registrosMostrados = Math.min((data.resultados || []).length, registrosPorPagina);

        if (totalRegistros > registrosPorPagina) {
            const inicio = ((paginaActual - 1) * registrosPorPagina) + 1;
            const fin = Math.min(paginaActual * registrosPorPagina, totalRegistros);
            document.getElementById('infoPagina').textContent = `Mostrando ${inicio}-${fin} de ${totalRegistros} registros`;
        } else {
            document.getElementById('infoPagina').textContent = `Mostrando ${totalRegistros} registros`;
        }
    }
}

// Event listener para b√∫squeda en tiempo real
document.getElementById('busqueda').addEventListener('input', function(e) {
    clearTimeout(window.busquedaTimeout);
    window.busquedaTimeout = setTimeout(() => {
        busquedaActual = e.target.value.trim();
        paginaActual = 1; // Resetear a la primera p√°gina
        cargarInformes();
    }, 500); // Debounce de 500ms
});

// Modificar la funci√≥n cargarInformes para incluir paginaci√≥n y b√∫squeda
function cargarInformes() {
    const formData = new FormData(document.getElementById('filtrosForm'));
    const params = new URLSearchParams();
    
    // Agregar todos los filtros
    for (const [key, value] of formData.entries()) {
        if (value) {
            if (Array.isArray(value)) {
                value.forEach(v => params.append(key, v));
            } else {
                params.append(key, value);
            }
        }
    }
    
    // Agregar par√°metros de paginaci√≥n y b√∫squeda
    params.append('page', paginaActual);
    params.append('per_page', registrosPorPagina);
    if (busquedaActual) {
        params.append('busqueda', busquedaActual);
    }
    
    fetch(`/api/informes/resultados?${params.toString()}`)
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                throw new Error(`Error HTTP ${response.status}: ${response.statusText}. Respuesta: ${text.substring(0, 200)}...`);
            });
        }
        return response.json();
    })
    .then(data => {
        console.log('üìä DEBUG - Datos recibidos del backend:', data);

        // Verificar estructura de respuesta
        if (!data || typeof data !== 'object') {
            throw new Error('Respuesta inv√°lida del servidor');
        }

        // Extraer estad√≠sticas (pueden estar en data.estadisticas)
        let estadisticas = data.estadisticas || {};

        console.log('üìä DEBUG - Estad√≠sticas extra√≠das:', estadisticas);

        // Actualizar estad√≠sticas correctamente
        document.getElementById('cantidad_torneos').textContent =
            estadisticas.cantidad_torneos || 0;
        document.getElementById('total_registros').textContent =
            estadisticas.total_registros || 0;

        // Total invertido (importes negativos como positivos)
        document.getElementById('total_invertido').textContent =
            '$' + (estadisticas.total_invertido || 0).toFixed(2);

        // Total ganancias (importes positivos)
        document.getElementById('total_ganancias').textContent =
            '$' + (estadisticas.total_ganancias || 0).toFixed(2);

        // ROI calculado en el backend
        document.getElementById('roi').textContent =
            (estadisticas.roi || 0).toFixed(2) + '%';

        // Suma de importes (balance total)
        const sumaImportes = estadisticas.suma_importes || 0;
        const colorSuma = sumaImportes >= 0 ? 'text-success' : 'text-danger';
        document.getElementById('suma_importes').textContent =
            '$' + sumaImportes.toFixed(2);
        document.getElementById('suma_importes').className =
            colorSuma + ' mb-0';

        // Resultado econ√≥mico (ganancias - inversi√≥n)
        const resultadoEconomico = estadisticas.resultado_economico || 0;
        const colorResultado = resultadoEconomico >= 0 ? 'text-success' : 'text-danger';
        document.getElementById('resultado_economico').textContent =
            '$' + resultadoEconomico.toFixed(2);
        document.getElementById('resultado_economico').className =
            colorResultado + ' mb-1';
            
            // Actualizar tabla
            console.log('üìä Datos recibidos:', (data.resultados || []).length, 'registros');
            window.datosResultados = data.resultados || [];
            actualizarTablaResultados();
            
            // Actualizar controles de paginaci√≥n
            actualizarControlesPaginacion(data);
            
            // Obtener datos para el gr√°fico de √∫ltimos 10 d√≠as
            obtenerDatosGrafico().then(resultadosDiarios => {
                generarGraficoResultadosDiarios(resultadosDiarios);
            });
        } else {
            console.error('Error en respuesta:', data.error || 'Respuesta inv√°lida');
            
            // Limpiar datos en caso de error
            document.getElementById('cantidad_torneos').textContent = '0';
            document.getElementById('total_registros').textContent = '0';
            document.getElementById('suma_importes').textContent = '$0.00';
            document.getElementById('total_invertido').textContent = '$0.00';
            document.getElementById('total_ganancias').textContent = '$0.00';
            document.getElementById('roi').textContent = '0.0%';
            document.getElementById('resultado_economico').textContent = '$0.00';
            
            // Mostrar mensaje de error m√°s amigable
            const estadisticasEl = document.getElementById('estadisticas');
            const tablaEl = document.getElementById('tablaResultados');
            const graficoEl = document.getElementById('graficoContainer');
            
            if (estadisticasEl) estadisticasEl.innerHTML = '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>Error al cargar estad√≠sticas</div>';
            if (tablaEl) tablaEl.innerHTML = '<tbody><tr><td colspan="9" class="text-center"><div class="alert alert-warning mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Error al cargar datos</div></td></tr></tbody>';
            if (graficoEl) graficoEl.innerHTML = '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>Error al cargar gr√°fico</div>';
            
            // Mostrar mensaje de error espec√≠fico
            let mensajeError = data.error || 'Error desconocido';
            
            // Verificar si es un error de conexi√≥n
            if (mensajeError.includes('conexi√≥n') || mensajeError.includes('Resource temporarily unavailable') || mensajeError.includes('ReadError')) {
                // Mostrar mensaje con opci√≥n de reintento
                mostrarErrorConReintento(mensajeError);
            } else {
                alert('Error al cargar los informes: ' + mensajeError);
            }
        }
    })
    .catch(error => {
        console.error('Error al cargar informes:', error);
        
        // Mostrar mensaje de error de conexi√≥n con reintento
        if (error.message.includes('Failed to fetch') || error.message.includes('ERR_EMPTY_RESPONSE')) {
            mostrarErrorConReintento('Error de conexi√≥n con el servidor. Intenta nuevamente en unos momentos.');
        } else {
            alert('Error de conexi√≥n: ' + error.message);
        }
    });
}

function mostrarErrorConReintento(mensaje) {
    // Crear modal de error con reintento
    const modalHtml = `
        <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-warning">
                        <h5 class="modal-title" id="errorModalLabel">
                            <i class="fas fa-exclamation-triangle me-2"></i>Error de Conexi√≥n
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>${mensaje}</p>
                        <p class="mb-0"><small class="text-muted">¬øDeseas intentar cargar los datos nuevamente?</small></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" onclick="reintentar()">
                            <i class="fas fa-sync-alt me-1"></i>Reintentar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Eliminar modal anterior si existe
    const existingModal = document.getElementById('errorModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Agregar modal al body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('errorModal'));
    modal.show();
}

function reintentar() {
    // Cerrar modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('errorModal'));
    if (modal) modal.hide();
    
    // Mostrar indicador de carga
    const estadisticasEl = document.getElementById('estadisticas');
    const tablaEl = document.getElementById('tablaResultados');
    const graficoEl = document.getElementById('graficoContainer');
    
    if (estadisticasEl) estadisticasEl.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin me-2"></i>Cargando estad√≠sticas...</div>';
    if (tablaEl) tablaEl.innerHTML = '<tbody><tr><td colspan="9" class="text-center"><i class="fas fa-spinner fa-spin me-2"></i>Cargando datos...</td></tr></tbody>';
    if (graficoEl) graficoEl.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin me-2"></i>Cargando gr√°fico...</div>';
    
    // Reintentar carga despu√©s de un peque√±o delay
    setTimeout(() => {
        cargarInformes();
    }, 1000);
}

// Cargar opciones y informes al cargar la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    cargarOpciones();
    // Cargar informes despu√©s de un peque√±o delay para que se carguen las opciones
    setTimeout(cargarInformes, 500);
});
</script>
{% endblock %}
