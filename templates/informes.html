{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-chart-bar me-2"></i>Informes de Resultados</h2>
        <p class="text-muted">Analiza tus resultados econÃ³micos y estadÃ­sticas de juego.</p>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Filtros</h6>
            </div>
            <div class="card-body">
                <form id="filtrosForm">
                    <div class="mb-3">
                        <label for="fecha_inicio" class="form-label">Fecha Inicio</label>
                        <input type="date" class="form-control" id="fecha_inicio" name="fecha_inicio">
                    </div>
                    
                    <div class="mb-3">
                        <label for="fecha_fin" class="form-label">Fecha Fin</label>
                        <input type="date" class="form-control" id="fecha_fin" name="fecha_fin">
                    </div>
                    
                    <!-- Filtros rÃ¡pidos de fechas -->
                    <div class="mb-3">
                        <label for="filtro_rapido" class="form-label">Filtros RÃ¡pidos</label>
                        <select class="form-select" id="filtro_rapido" onchange="aplicarFiltroRapido(this.value)">
                            <option value="">Seleccionar perÃ­odo...</option>
                            <option value="hoy">ðŸ“… Hoy</option>
                            <option value="ayer">ðŸ“… Ayer</option>
                            <option value="esta_semana">ðŸ“… Esta Semana</option>
                            <option value="este_mes">ðŸ“… Este Mes</option>
                            <option value="mes_pasado">ðŸ“… Mes Pasado</option>
                            <option value="este_aÃ±o">ðŸ“… Este AÃ±o</option>
                            <option value="aÃ±o_pasado">ðŸ“… AÃ±o Pasado</option>
                            <option value="2024">ðŸ“… 2024</option>
                            <option value="2023">ðŸ“… 2023</option>
                            <option value="2022">ðŸ“… 2022</option>
                            <option value="2021">ðŸ“… 2021</option>
                            <option value="2020">ðŸ“… 2020</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="tipo_movimiento" class="form-label">Tipo de Movimiento</label>
                        <select class="form-select" id="tipo_movimiento" name="tipo_movimiento">
                            <option value="">Todos</option>
                            <option value="Buy-in">Buy-in</option>
                            <option value="Cashout">Cashout</option>
                            <option value="Fee">Fee</option>
                            <option value="Prize">Prize</option>
                        </select>
                    </div>
                    
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">CategorÃ­as</label>
                            <div>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="seleccionarTodos('categorias[]')">Todos</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deseleccionarTodos('categorias[]')">Ninguno</button>
                            </div>
                        </div>
                        <div id="categorias-filtro" class="border rounded p-2" style="max-height: 150px; overflow-y: auto;">
                            <!-- Se llenarÃ¡ dinÃ¡micamente -->
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">Tipos de Juego</label>
                            <div>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="seleccionarTodos('tipos_juego[]')">Todos</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deseleccionarTodos('tipos_juego[]')">Ninguno</button>
                            </div>
                        </div>
                        <div id="tipos-juego-filtro" class="border rounded p-2" style="max-height: 150px; overflow-y: auto;">
                            <!-- Se llenarÃ¡ dinÃ¡micamente -->
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">Nivel de Buy-in</label>
                            <div>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="seleccionarTodos('niveles_buyin[]')">Todos</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deseleccionarTodos('niveles_buyin[]')">Ninguno</button>
                            </div>
                        </div>
                        <div id="niveles-buyin-filtro" class="border rounded p-2" style="max-height: 150px; overflow-y: auto;">
                            <!-- Se llenarÃ¡ dinÃ¡micamente -->
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">Sala</label>
                            <div>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="seleccionarTodos('salas[]')">Todos</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deseleccionarTodos('salas[]')">Ninguno</button>
                            </div>
                        </div>
                        <div id="salas-filtro" class="border rounded p-2" style="max-height: 150px; overflow-y: auto;">
                            <!-- Se llenarÃ¡ dinÃ¡micamente -->
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-filter me-2"></i>Aplicar Filtros
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">EstadÃ­sticas Generales</h6>
            </div>
            <div class="card-body">
                <div class="row" id="estadisticas">
                    <!-- Primera fila -->
                    <div class="col-md-3 text-center mb-3">
                        <div class="border rounded p-3 h-100">
                            <h4 class="text-success mb-1" id="cantidad_torneos" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">0</h4>
                            <small class="text-muted">Torneos Jugados</small>
                        </div>
                    </div>
                    <div class="col-md-3 text-center mb-3">
                        <div class="border rounded p-3 h-100">
                            <h4 class="text-danger mb-1" id="total_invertido" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">$0.00</h4>
                            <small class="text-muted">Total Invertido</small>
                        </div>
                    </div>
                    <div class="col-md-3 text-center mb-3">
                        <div class="border rounded p-3 h-100">
                            <h4 class="text-success mb-1" id="total_ganancias" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">$0.00</h4>
                            <small class="text-muted">Total Ganancias</small>
                        </div>
                    </div>
                    <div class="col-md-3 text-center mb-3">
                        <div class="border rounded p-3 h-100">
                            <h4 class="text-info mb-1" id="total_registros" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">0</h4>
                            <small class="text-muted">Total Registros</small>
                            <div class="mt-2">
                                <h5 class="text-secondary mb-0" id="suma_importes" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">$0.00</h5>
                                <small class="text-muted">Suma Importes</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Segunda fila -->
                    <div class="col-md-6 text-center mb-3">
                        <div class="border rounded p-3 h-100">
                            <h4 class="text-warning mb-1" id="roi" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">0%</h4>
                            <small class="text-muted">ROI</small>
                        </div>
                    </div>
                    <div class="col-md-6 text-center mb-3">
                        <div class="border rounded p-3 h-100">
                            <h4 class="text-primary mb-1" id="resultado_economico" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">$0.00</h4>
                            <small class="text-muted">Resultado EconÃ³mico</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- GrÃ¡fico de resultados diarios -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">Resultados Diarios (Ãšltimos 10 DÃ­as)</h6>
            </div>
            <div class="card-body">
                <canvas id="graficoResultadosDiarios" style="height: 200px;"></canvas>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">Resultados Detallados</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="tablaResultados" style="font-size: 0.875rem;">
                        <thead>
                            <tr>
                                <th class="sortable" data-column="fecha" style="cursor: pointer;">
                                    Fecha <i class="fas fa-sort ms-1"></i>
                                </th>
                                <th class="sortable" data-column="hora" style="cursor: pointer;">
                                    Hora <i class="fas fa-sort ms-1"></i>
                                </th>
                                <th class="sortable" data-column="tipo_movimiento" style="cursor: pointer;">
                                    Tipo <i class="fas fa-sort ms-1"></i>
                                </th>
                                <th class="sortable" data-column="descripcion" style="cursor: pointer;">
                                    DescripciÃ³n <i class="fas fa-sort ms-1"></i>
                                </th>
                                <th class="sortable" data-column="importe" style="cursor: pointer;">
                                    Importe <i class="fas fa-sort ms-1"></i>
                                </th>
                                <th class="sortable" data-column="categoria" style="cursor: pointer;">
                                    CategorÃ­a <i class="fas fa-sort ms-1"></i>
                                </th>
                                <th class="sortable" data-column="tipo_juego" style="cursor: pointer;">
                                    Juego <i class="fas fa-sort ms-1"></i>
                                </th>
                                <th class="sortable" data-column="nivel_buyin" style="cursor: pointer;">
                                    Nivel Buy-in <i class="fas fa-sort ms-1"></i>
                                </th>
                                <th class="sortable" data-column="sala" style="cursor: pointer;">
                                    Sala <i class="fas fa-sort ms-1"></i>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Los datos se cargarÃ¡n dinÃ¡micamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let opcionesDisponibles = {};

document.getElementById('filtrosForm').addEventListener('submit', function(e) {
    e.preventDefault();
    cargarInformes();
});

function cargarOpciones() {
    fetch('/api/informes/opciones')
    .then(response => response.json())
    .then(data => {
        opcionesDisponibles = data;
        crearFiltrosMultiples();
    })
    .catch(error => {
        console.error('Error al cargar opciones:', error);
    });
}

function crearFiltrosMultiples() {
    // Crear filtros de categorÃ­as
    const categoriasDiv = document.getElementById('categorias-filtro');
    categoriasDiv.innerHTML = '';
    
    opcionesDisponibles.categorias.forEach(categoria => {
        const div = document.createElement('div');
        div.className = 'form-check';
        div.innerHTML = `
            <input class="form-check-input" type="checkbox" value="${categoria}" 
                   id="cat_${categoria}" name="categorias[]">
            <label class="form-check-label" for="cat_${categoria}">
                ${categoria}
            </label>
        `;
        categoriasDiv.appendChild(div);
    });
    
    // Crear filtros de tipos de juego
    const tiposJuegoDiv = document.getElementById('tipos-juego-filtro');
    tiposJuegoDiv.innerHTML = '';
    
    opcionesDisponibles.tipos_juego.forEach(tipo => {
        const div = document.createElement('div');
        div.className = 'form-check';
        div.innerHTML = `
            <input class="form-check-input" type="checkbox" value="${tipo}" 
                   id="tipo_${tipo}" name="tipos_juego[]">
            <label class="form-check-label" for="tipo_${tipo}">
                ${tipo}
            </label>
        `;
        tiposJuegoDiv.appendChild(div);
    });
    
    // Crear filtros de niveles de buy-in
    const nivelesBuyinDiv = document.getElementById('niveles-buyin-filtro');
    nivelesBuyinDiv.innerHTML = '';
    
    opcionesDisponibles.niveles_buyin.forEach(nivel => {
        const div = document.createElement('div');
        div.className = 'form-check';
        div.innerHTML = `
            <input class="form-check-input" type="checkbox" value="${nivel}" 
                   id="nivel_${nivel}" name="niveles_buyin[]">
            <label class="form-check-label" for="nivel_${nivel}">
                ${nivel}
            </label>
        `;
        nivelesBuyinDiv.appendChild(div);
    });
    
    // Crear filtros de salas
    const salasDiv = document.getElementById('salas-filtro');
    salasDiv.innerHTML = '';
    
    opcionesDisponibles.salas.forEach(sala => {
        const div = document.createElement('div');
        div.className = 'form-check';
        div.innerHTML = `
            <input class="form-check-input" type="checkbox" value="${sala}" 
                   id="sala_${sala}" name="salas[]">
            <label class="form-check-label" for="sala_${sala}">
                ${sala}
            </label>
        `;
        salasDiv.appendChild(div);
    });
    
    // Actualizar opciones de tipo de movimiento
    const tipoMovimientoSelect = document.getElementById('tipo_movimiento');
    tipoMovimientoSelect.innerHTML = '<option value="">Todos</option>';
    opcionesDisponibles.tipos_movimiento.forEach(tipo => {
        const option = document.createElement('option');
        option.value = tipo;
        option.textContent = tipo;
        tipoMovimientoSelect.appendChild(option);
    });
}

function cargarInformes() {
    const formData = new FormData(document.getElementById('filtrosForm'));
    const params = new URLSearchParams();
    
    // Agregar filtros bÃ¡sicos
    for (let [key, value] of formData.entries()) {
        if (value && key !== 'categorias[]' && key !== 'tipos_juego[]' && key !== 'niveles_buyin[]' && key !== 'salas[]') {
            params.append(key, value);
        }
    }
    
    // Agregar filtros mÃºltiples
    const categoriasSeleccionadas = Array.from(document.querySelectorAll('input[name="categorias[]"]:checked'))
        .map(cb => cb.value);
    categoriasSeleccionadas.forEach(cat => params.append('categorias[]', cat));
    
    const tiposJuegoSeleccionados = Array.from(document.querySelectorAll('input[name="tipos_juego[]"]:checked'))
        .map(cb => cb.value);
    tiposJuegoSeleccionados.forEach(tipo => params.append('tipos_juego[]', tipo));
    
    const nivelesBuyinSeleccionados = Array.from(document.querySelectorAll('input[name="niveles_buyin[]"]:checked'))
        .map(cb => cb.value);
    nivelesBuyinSeleccionados.forEach(nivel => params.append('niveles_buyin[]', nivel));
    
    const salasSeleccionadas = Array.from(document.querySelectorAll('input[name="salas[]"]:checked'))
        .map(cb => cb.value);
    salasSeleccionadas.forEach(sala => params.append('salas[]', sala));
    
    fetch(`/api/informes/resultados?${params}`)
    .then(response => response.json())
    .then(data => {
        // Actualizar estadÃ­sticas
        document.getElementById('cantidad_torneos').textContent = 
            data.estadisticas.cantidad_torneos;
        document.getElementById('total_registros').textContent = 
            data.estadisticas.total_registros;
        
        // Suma de importes
        const sumaImportes = data.estadisticas.suma_importes;
        const colorSuma = sumaImportes >= 0 ? 'text-success' : 'text-danger';
        document.getElementById('suma_importes').textContent = 
            '$' + sumaImportes.toFixed(2);
        document.getElementById('suma_importes').className = 
            colorSuma + ' mb-0';
        
        // Nuevas estadÃ­sticas
        document.getElementById('total_invertido').textContent = 
            '$' + data.estadisticas.total_invertido.toFixed(2);
        document.getElementById('total_ganancias').textContent = 
            '$' + data.estadisticas.total_ganancias.toFixed(2);
        
        // ROI calculado correctamente
        document.getElementById('roi').textContent = 
            data.estadisticas.roi.toFixed(1) + '%';
        
        // Resultado econÃ³mico
        const resultadoEconomico = data.estadisticas.resultado_economico;
        const colorResultado = resultadoEconomico >= 0 ? 'text-success' : 'text-danger';
        document.getElementById('resultado_economico').textContent = 
            '$' + resultadoEconomico.toFixed(2);
        document.getElementById('resultado_economico').className = 
            colorResultado;
        
        // Generar grÃ¡fico de resultados diarios cuando el DOM estÃ© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(() => {
                    generarGraficoResultadosDiarios(data.resultados_diarios);
                }, 1000);
            });
        } else {
            setTimeout(() => {
                generarGraficoResultadosDiarios(data.resultados_diarios);
            }, 1000);
        }
        
        // Almacenar datos globalmente para ordenamiento
        datosResultados = data.resultados;
        
        // Actualizar tabla usando la funciÃ³n de ordenamiento
        actualizarTablaResultados();
    })
    .catch(error => {
        console.error('Error al cargar informes:', error);
        alert('Error al cargar los informes');
    });
}

// Funciones para seleccionar/deseleccionar todos los filtros
// FunciÃ³n para aplicar filtros rÃ¡pidos de fechas
function aplicarFiltroRapido(tipo) {
    // Si no se seleccionÃ³ nada, no hacer nada
    if (!tipo) return;
    
    const hoy = new Date();
    const fechaInicio = document.getElementById('fecha_inicio');
    const fechaFin = document.getElementById('fecha_fin');
    const filtroRapido = document.getElementById('filtro_rapido');
    
    let inicio, fin;
    
    switch(tipo) {
        case 'hoy':
            inicio = fin = hoy;
            break;
            
        case 'ayer':
            const ayer = new Date(hoy);
            ayer.setDate(hoy.getDate() - 1);
            inicio = fin = ayer;
            break;
            
        case 'esta_semana':
            const inicioSemana = new Date(hoy);
            inicioSemana.setDate(hoy.getDate() - hoy.getDay()); // Domingo
            const finSemana = new Date(hoy);
            finSemana.setDate(hoy.getDate() + (6 - hoy.getDay())); // SÃ¡bado
            inicio = inicioSemana;
            fin = finSemana;
            break;
            
        case 'este_mes':
            inicio = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
            fin = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0);
            break;
            
        case 'mes_pasado':
            const mesPasado = new Date(hoy.getFullYear(), hoy.getMonth() - 1, 1);
            inicio = new Date(mesPasado.getFullYear(), mesPasado.getMonth(), 1);
            fin = new Date(mesPasado.getFullYear(), mesPasado.getMonth() + 1, 0);
            break;
            
        case 'este_aÃ±o':
            inicio = new Date(hoy.getFullYear(), 0, 1);
            fin = new Date(hoy.getFullYear(), 11, 31);
            break;
            
        case 'aÃ±o_pasado':
            const aÃ±oPasado = hoy.getFullYear() - 1;
            inicio = new Date(aÃ±oPasado, 0, 1);
            fin = new Date(aÃ±oPasado, 11, 31);
            break;
            
        case '2024':
            inicio = new Date(2024, 0, 1);
            fin = new Date(2024, 11, 31);
            break;
            
        case '2023':
            inicio = new Date(2023, 0, 1);
            fin = new Date(2023, 11, 31);
            break;
            
        case '2022':
            inicio = new Date(2022, 0, 1);
            fin = new Date(2022, 11, 31);
            break;
            
        case '2021':
            inicio = new Date(2021, 0, 1);
            fin = new Date(2021, 11, 31);
            break;
            
        case '2020':
            inicio = new Date(2020, 0, 1);
            fin = new Date(2020, 11, 31);
            break;
            
        default:
            return;
    }
    
    // Formatear fechas para el input date (YYYY-MM-DD)
    const formatearFecha = (fecha) => {
        return fecha.getFullYear() + '-' + 
               String(fecha.getMonth() + 1).padStart(2, '0') + '-' + 
               String(fecha.getDate()).padStart(2, '0');
    };
    
    // Aplicar las fechas
    fechaInicio.value = formatearFecha(inicio);
    fechaFin.value = formatearFecha(fin);
    
    // Resetear el menÃº desplegable
    filtroRapido.value = '';
    
    // Recargar informes automÃ¡ticamente
    cargarInformes();
}

function seleccionarTodos(name) {
    const checkboxes = document.querySelectorAll(`input[name="${name}"]`);
    checkboxes.forEach(cb => cb.checked = true);
}

function deseleccionarTodos(name) {
    const checkboxes = document.querySelectorAll(`input[name="${name}"]`);
    checkboxes.forEach(cb => cb.checked = false);
}

// FunciÃ³n para generar el grÃ¡fico de resultados diarios
function generarGraficoResultadosDiarios(resultadosDiarios) {
    console.log('Intentando generar grÃ¡fico...', resultadosDiarios);
    
    const ctx = document.getElementById('graficoResultadosDiarios');
    
    // Verificar que el elemento existe
    if (!ctx) {
        console.error('No se encontrÃ³ el elemento graficoResultadosDiarios');
        return;
    }
    
    // Verificar que el elemento estÃ¡ visible y tiene dimensiones
    if (ctx.offsetWidth === 0 || ctx.offsetHeight === 0) {
        console.error('El elemento graficoResultadosDiarios no tiene dimensiones visibles');
        console.log('Reintentando en 500ms...');
        setTimeout(() => {
            generarGraficoResultadosDiarios(resultadosDiarios);
        }, 500);
        return;
    }
    
    console.log('Elemento encontrado:', ctx);
    console.log('Dimensiones:', ctx.offsetWidth, 'x', ctx.offsetHeight);
    
    // Destruir grÃ¡fico existente si existe
    if (window.graficoResultadosDiarios && typeof window.graficoResultadosDiarios.destroy === 'function') {
        console.log('Destruyendo grÃ¡fico existente...');
        window.graficoResultadosDiarios.destroy();
    }
    
    // Preparar datos
    const fechas = resultadosDiarios.map(d => {
        const fecha = new Date(d.fecha);
        return fecha.toLocaleDateString('es-ES', { month: 'short', day: 'numeric' });
    });
    
    const resultados = resultadosDiarios.map(d => d.resultado);
    const colores = resultados.map(r => r >= 0 ? '#28a745' : '#dc3545');
    
    // Crear grÃ¡fico con manejo de errores
    console.log('Preparando datos para el grÃ¡fico...');
    console.log('Fechas:', fechas);
    console.log('Resultados:', resultados);
    console.log('Colores:', colores);
    
    try {
        console.log('Creando grÃ¡fico con Chart.js...');
        window.graficoResultadosDiarios = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: fechas,
                datasets: [{
                    label: 'Resultado Diario ($)',
                    data: resultados,
                    backgroundColor: colores,
                    borderColor: colores,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const valor = context.parsed.y;
                                const movimientos = resultadosDiarios[context.dataIndex].movimientos;
                                return `$${valor.toFixed(2)} (${movimientos} movimientos)`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toFixed(0);
                            }
                        }
                    },
                    x: {
                        ticks: {
                            maxRotation: 45
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error al crear el grÃ¡fico:', error);
        // Mostrar mensaje de error en el contenedor
        ctx.innerHTML = '<div class="alert alert-warning">Error al cargar el grÃ¡fico de resultados diarios</div>';
    }
}

// Variables globales para ordenamiento
let datosResultados = [];
let ordenActual = { columna: null, direccion: 'asc' };

// FunciÃ³n para ordenar los datos
function ordenarDatos(columna, direccion) {
    datosResultados.sort((a, b) => {
        let valorA = a[columna];
        let valorB = b[columna];
        
        // Manejar valores nulos o undefined
        if (valorA === null || valorA === undefined) valorA = '';
        if (valorB === null || valorB === undefined) valorB = '';
        
        // Convertir a string para comparaciÃ³n
        valorA = String(valorA).toLowerCase();
        valorB = String(valorB).toLowerCase();
        
        // Ordenamiento especial para fechas
        if (columna === 'fecha') {
            valorA = new Date(a.fecha);
            valorB = new Date(b.fecha);
        }
        
        // Ordenamiento especial para importes
        if (columna === 'importe') {
            valorA = parseFloat(a.importe) || 0;
            valorB = parseFloat(b.importe) || 0;
        }
        
        // Ordenamiento especial para hora
        if (columna === 'hora') {
            valorA = a.hora ? new Date('1970-01-01T' + a.hora) : new Date('1970-01-01T00:00:00');
            valorB = b.hora ? new Date('1970-01-01T' + b.hora) : new Date('1970-01-01T00:00:00');
        }
        
        if (direccion === 'asc') {
            return valorA < valorB ? -1 : valorA > valorB ? 1 : 0;
        } else {
            return valorA > valorB ? -1 : valorA < valorB ? 1 : 0;
        }
    });
    
    // Actualizar la tabla con los datos ordenados
    actualizarTablaResultados();
}

// FunciÃ³n para actualizar la tabla con los datos ordenados
function actualizarTablaResultados() {
    const tbody = document.querySelector('#tablaResultados tbody');
    tbody.innerHTML = '';
    
    datosResultados.forEach(resultado => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${resultado.fecha}</td>
            <td>${resultado.hora || '-'}</td>
            <td>${resultado.tipo_movimiento}</td>
            <td>${resultado.descripcion}</td>
            <td class="${resultado.importe >= 0 ? 'text-success' : 'text-danger'}">
                $${resultado.importe.toFixed(2)}
            </td>
            <td>${resultado.categoria}</td>
            <td>${resultado.tipo_juego}</td>
            <td>${resultado.nivel_buyin || '-'}</td>
            <td>${resultado.sala}</td>
        `;
        tbody.appendChild(row);
    });
}

// FunciÃ³n para manejar el clic en los headers
function manejarOrdenamiento(columna) {
    // Determinar la direcciÃ³n del ordenamiento
    let direccion = 'asc';
    if (ordenActual.columna === columna && ordenActual.direccion === 'asc') {
        direccion = 'desc';
    }
    
    // Actualizar el estado del ordenamiento
    ordenActual.columna = columna;
    ordenActual.direccion = direccion;
    
    // Actualizar los iconos de ordenamiento
    document.querySelectorAll('.sortable i').forEach(icon => {
        icon.className = 'fas fa-sort ms-1';
    });
    
    // Actualizar el icono de la columna actual
    const headerActual = document.querySelector(`[data-column="${columna}"] i`);
    if (direccion === 'asc') {
        headerActual.className = 'fas fa-sort-up ms-1 text-primary';
    } else {
        headerActual.className = 'fas fa-sort-down ms-1 text-primary';
    }
    
    // Ordenar los datos
    ordenarDatos(columna, direccion);
}

// Agregar event listeners a los headers
document.addEventListener('DOMContentLoaded', function() {
    // Esperar a que se carguen los datos antes de agregar los event listeners
    setTimeout(() => {
        document.querySelectorAll('.sortable').forEach(header => {
            header.addEventListener('click', function() {
                const columna = this.getAttribute('data-column');
                manejarOrdenamiento(columna);
            });
        });
    }, 1000);
});

// Cargar opciones y informes al cargar la pÃ¡gina
document.addEventListener('DOMContentLoaded', function() {
    cargarOpciones();
    // Cargar informes despuÃ©s de un pequeÃ±o delay para que se carguen las opciones
    setTimeout(cargarInformes, 500);
});
</script>
{% endblock %}
